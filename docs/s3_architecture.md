# S3 Architecture (bacs-mc-uploads)

This repo uses S3 as the primary storage layer for:
- user-uploaded assets (videos, images, logos, audio)
- derived assets (thumbnails, edit proxies, timeline sprites, audio envelope)
- ffmpeg “mastering” intermediates (trim/intro/audio/visual stages)
- captions (VTT)

The canonical metadata source-of-truth is MariaDB (`uploads`, `productions`, `media_jobs`, etc). S3 prefixes are an *organizational convention* to support operability (debugging, lifecycle policies, cost control).

## Buckets

- `UPLOAD_BUCKET` (default: `bacs-mc-uploads`): uploads + ffmpeg artifacts + captions.
- `OUTPUT_BUCKET` (default: `bacs-mc-public-stream`): MediaConvert HLS outputs (fronted by CloudFront).

## Prefixes (top-level)

### Raw / user-managed assets (tracked in `uploads`)

- `videos/` — raw video uploads (newer layout), e.g. `videos/YYYY-MM/DD/<uuid>/video.mp4`
- `audio/` — audio uploads (system library), e.g. `audio/YYYY-MM/DD/<uuid>/<file>`
- `logos/` — logo images, e.g. `logos/YYYY-MM/DD/<uuid>/logo.png`
- `images/` — images (title pages, overlay images, lower-third images), e.g. `images/YYYY-MM/DD/<uuid>/image.png`

**Legacy (date-at-root)**

- `YYYY-MM/` — legacy raw video uploads stored at the bucket root by date (e.g. `2025-11/DD/<uuid>/video.mp4`). These are still valid inputs; do not delete without migration.

### Derived per-upload assets (regeneratable; not separate `uploads` rows)

- `thumbs/` — upload thumbnails (first-frame JPEG), key format: `thumbs/uploads/<uploadId>/thumb.jpg`
- `proxies/` — edit UI artifacts:
  - edit proxy MP4: `proxies/uploads/<uploadId>/edit_proxy.mp4`
  - audio envelope JSON (for waveform): `proxies/uploads/<uploadId>/audio/audio_envelope_v3.json`

### Captions (production-level; persisted outputs)

- `captions/` — VTT captions, key format: `captions/vtt/production_<productionId>.vtt`

### Dynamic overlay images for packaging (MediaConvert consumption)

These PNGs are generated by ffmpeg and burned by MediaConvert (Image Inserter) in some pipelines.

- `lower-thirds/` — overlay PNGs (includes screen-title overlays), e.g. `lower-thirds/screen-titles/<YYYY-MM/DD>/<productionUlid>/<uuid>/{portrait,landscape}.png`

### ffmpeg mastering intermediates (debugging-friendly; stage outputs)

These prefixes hold MP4 stage outputs that are then used as inputs to the next stage and/or handed off to MediaConvert.

- `video-trim/` — trimmed/spliced MP4 stage (edits applied)
- `intro-freeze/` — frozen-first-frame intro MP4 stage
- `intro-title/` — title-image intro MP4 stage
- `music-replace/` and `music-replace-clip/` — audio replace MP4 stage (loop/pad/optional duration clip)
- `music-mix/` and `music-mix-clip/` — audio mix MP4 stage (no ducking)
- `music-mix-duck-clip/` — rolling duck mix stage (sidechain compression)
- `music-mix-gate-clip/` — opener cutoff (“gate”) mix stage (analyze and fade/cut around `t`)
- `video-master/` — visual master stage (burns overlays like logo/lower-third/screen-title/timeline overlays)
- `mastered/` — mastered MP4 stage (used as MediaConvert input in audio-master flows)

## What writes what

- Upload ingest (API + presigned POST): writes raw assets under `videos/`, `audio/`, `logos/`, `images/` (or legacy date-at-root for older rows).
- Upload processing (media jobs worker):
  - `upload_thumb_v1` → `thumbs/uploads/<id>/thumb.jpg`
  - `upload_edit_proxy_v1` → `proxies/uploads/<id>/edit_proxy.mp4`
  - `upload_audio_envelope_v*` → `proxies/uploads/<id>/audio/audio_envelope_v3.json`
- Production mastering (media jobs worker):
  - video trim/splice → `video-trim/*`
  - intro stages → `intro-freeze/*`, `intro-title/*`
  - audio stages → `music-*/*`
  - visual stage → `video-master/*`
  - “mastered” MP4 → `mastered/*`
- Captions/transcription:
  - AssemblyAI transcript job → `captions/vtt/production_<id>.vtt`

## Retention policy (first pass)

This is a **recommended starting point**. The app currently keeps artifacts for debugging; cleanup automation can be added once the pipeline is stable.

| Prefix group | Examples | Regeneratable? | Suggested retention (success) | Suggested retention (failed) |
|---|---|---:|---:|---:|
| Raw uploads | `videos/`, legacy `YYYY-MM/` | No | Keep until user deletes | Keep |
| User assets | `logos/`, `images/`, `audio/` | No | Keep until user/admin deletes | Keep |
| Per-upload derived | `thumbs/`, `proxies/` | Yes | Keep (or expire after long inactivity, e.g. 90–180d) | Keep |
| Captions | `captions/` | Yes (but costly/time) | Keep | Keep |
| Stage intermediates | `video-trim/`, `intro-*`, `music-*` | Yes | 7–30 days | Keep (until manual cleanup) |
| Master MP4 | `video-master/`, `mastered/` | Yes | 30–90 days | Keep |

## Notes for future cleanup tooling

When implementing automated cleanup, prefer:
- **DB-driven deletion lists**: use `media_jobs.result_json` and/or an explicit outputs table to enumerate keys to delete.
- **Safety first**: dry-run output; delete by prefix; protect raw `uploads.s3_key` objects.
- **Lifecycle rules**: once prefixes are stable, S3 lifecycle policies are a good fit for `intro-*`, `music-*`, etc.
