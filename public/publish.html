<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Publish Videos</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      table { border-collapse: collapse; width: 100%; max-width: 960px; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background: #f5f5f5; text-align: left; }
      button { padding: 0.3rem 0.6rem; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h2>Uploaded Videos</h2>
    <div style="margin: 0 0 1rem 0;">
      <label for="profile">Profile:</label>
      <select id="profile">
        <option value="auto" selected>Auto (by orientation)</option>
      </select>
      <label for="quality" style="margin-left:12px;">Quality:</label>
      <select id="quality">
        <option value="standard" selected>Standard</option>
        <option value="hq">High Quality</option>
      </select>
      <label for="sound" style="margin-left:12px;">Sound:</label>
      <select id="sound">
        <option value="original" selected>Original</option>
        <option value="normalize">Normalize (-16 LUFS)</option>
      </select>
      <input id="admintoken" type="password" placeholder="Admin token (optional)" style="margin-left:12px; padding:3px 6px;" />
    </div>
    <p class="muted">Only showing latest 50 by default.</p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Filename</th>
          <th>Size</th>
          <th>WxH</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      const rows = document.getElementById('rows');

      function fmtBytes(n){
        if (!n && n !== 0) return '';
        const units = ['B','KB','MB','GB','TB'];
        let i=0, v = n;
        while (v >= 1024 && i < units.length-1) { v/=1024; i++; }
        return v.toFixed(1)+' '+units[i];
      }

      async function load(){
        // Populate profiles from server
        try {
          const pres = await fetch('/api/profiles');
          const pj = await pres.json();
          const sel = document.getElementById('profile');
          // Keep Auto option
          Array.from(sel.options).forEach((o, i) => { if (i>0) sel.removeChild(o); });
          (pj.profiles || []).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name; sel.appendChild(opt);
          });
        } catch {}

        const res = await fetch('/api/uploads?limit=50');
        const data = await res.json();
        rows.innerHTML = '';
        data.forEach((u) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              ${u.id}
            </td>
            <td title="${u.s3_key}">
              ${u.original_filename}
            </td>
            <td>${fmtBytes(u.size_bytes)}</td>
            <td>${u.width||''}x${u.height||''}</td>
            <td>${u.status}</td>
            <td>
              ${u.status === 'uploaded' ? `<button data-id="${u.id}">Publish</button>` : `<span class="muted">-</span>`}
            </td>
          `;
          rows.appendChild(tr);
        });

        const profileSel = document.getElementById('profile');
        const qualitySel = document.getElementById('quality');
        const soundSel = document.getElementById('sound');
        const adminToken = document.getElementById('admintoken');
        rows.querySelectorAll('button[data-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            e.currentTarget.disabled = true;
            e.currentTarget.textContent = 'Publishing...';
            try {
              const prof = profileSel.value;
              const quality = qualitySel.value;
              const sound = soundSel.value;
              const body = prof && prof !== 'auto' ? { id: Number(id), profile: prof, quality, sound } : { id: Number(id), quality, sound };
              const headers = {'Content-Type':'application/json'};
              if (adminToken.value) headers['x-admin-token'] = adminToken.value;
              const resp = await fetch('/api/publish', { method:'POST', headers, body: JSON.stringify(body) });
              const json = await resp.json();
              if (!resp.ok) throw new Error(json.error || 'Failed');
            } catch (err) {
              alert('Publish failed: ' + err.message);
            } finally {
              await load();
            }
          });
        });
      }

      load();
    </script>
  </body>
  </html>
