<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€¢ Channel</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1>Admin</h1>
      <a href="/admin/settings">Site Settings</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/groups">Groups</a>
      <a href="/admin/channels">Channels</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2 id="title">Channel</h2>
        <div class="field"><label for="name">Name</label><input id="name" type="text" /></div>
        <label style="display:flex; gap:8px; align-items:center; margin:8px 0;">
          <input type="checkbox" id="requireReview" />
          Require Review/Approval
          <span id="requireReviewNote" style="margin-left:8px; color:#666; font-size:12px;"></span>
        </label>
        <div id="reviewBanner" style="border:1px solid #e3e8f3; background:#f0f3fa; color:#222; padding:8px 10px; border-radius:8px; font-size:13px; margin:8px 0;">
          
        </div>
        <div class="field">
          <label for="commentsPolicy">Comments Policy</label>
          <select id="commentsPolicy">
            <option value="on">On</option>
            <option value="off">Off</option>
            <option value="inherit">Inherit</option>
          </select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;"><button class="btn" id="saveBtn">Save Settings</button><a class="btn" href="/admin/channels">Back</a></div>
        <div class="status" id="status"></div>
      </div>

      <div class="section">
        <h3>Members</h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input type="number" id="addUserId" placeholder="User ID" />
          <div id="rolesBox" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
          <button class="btn" id="addBtn">Add Member</button>
        </div>
        <table>
          <thead><tr><th>User ID</th><th>Display Name</th><th>Email</th><th>Roles</th><th>Actions</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div class="section">
        <h3>Delete Channel</h3>
        <div class="muted" id="delNote">All members must be removed before deletion.</div>
        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <button class="btn danger" id="deleteBtn" disabled>Delete Channel</button>
        </div>
        <div class="status" id="deleteStatus"></div>
      </div>
    </main>
    <script>
      const idMatch = location.pathname.match(/\/admin\/channels\/(\d+)/); const spaceId = idMatch? Number(idMatch[1]) : null;
      const csrf=()=>{const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/);return m?decodeURIComponent(m[1]):null};
      const headers=()=>{const h={'Content-Type':'application/json'};const t=csrf();if(t)h['x-csrf-token']=t;return h};
      let allRoles=[];
      let siteRequireChannel=false;
      function setBanner(siteReq, spaceReq){
        const el = document.getElementById('reviewBanner');
        if (!el) return;
        if (siteReq) { el.textContent = 'Effective Review: Required (Site enforced)'; return; }
        if (spaceReq) { el.textContent = 'Effective Review: Required (Space setting)'; return; }
        el.textContent = 'Effective Review: Not required';
      }
      function renderRoleChecks(containerId){
        const c=document.getElementById(containerId); c.innerHTML='';
        const spaceRoles = allRoles.filter(ro => {
          if (ro.scope) return ro.scope === 'space' && String(ro.name||'').startsWith('space_');
          const n = String(ro.name||'');
          return /^space_/.test(n);
        });
        spaceRoles.forEach(r=>{
          const id=`role_${r.name}`; const label=document.createElement('label'); label.style.display='flex'; label.style.gap='6px'; label.style.alignItems='center';
          label.innerHTML = `<input type=\"checkbox\" id=\"${id}\" data-role=\"${r.name}\"/> ${r.name}`;
          c.appendChild(label);
        })
      }
      async function loadRoles(){ const res=await fetch('/api/admin/roles', { credentials:'same-origin' }); const data=await res.json(); allRoles=data.roles||[]; renderRoleChecks('rolesBox'); }
      async function loadSite(){ try{ const r=await fetch('/api/admin/site-settings', { credentials:'same-origin' }); const d=await r.json(); siteRequireChannel=!!d.requireChannelReview; }catch(e){ siteRequireChannel=false; } }
      async function load(){
        if(!spaceId) return;
        try{
          const sres = await fetch(`/api/admin/spaces/${spaceId}`, { credentials:'same-origin' }); const s = await sres.json();
          document.getElementById('title').textContent = `Channel #${s.id}`; document.getElementById('name').value = s.name||'';
          // Require Review checkbox
          try{
            const rrEl = document.getElementById('requireReview');
            const noteEl = document.getElementById('requireReviewNote');
            const req = (s.settings && s.settings.publishing && typeof s.settings.publishing.requireApproval === 'boolean')
              ? !!s.settings.publishing.requireApproval
              : true; // channel default: on
            rrEl.checked = siteRequireChannel ? true : req;
            rrEl.disabled = siteRequireChannel;
            noteEl.textContent = siteRequireChannel ? 'Enforced by Site settings' : '';
            setBanner(siteRequireChannel, rrEl.checked);
            if (!siteRequireChannel) {
              rrEl.addEventListener('change',()=>{ setBanner(false, rrEl.checked); });
            }
          }catch{}
          const cp = (s.settings && s.settings.comments) ? String(s.settings.comments) : 'on';
          const sel = document.getElementById('commentsPolicy');
          if (sel) sel.value = ['on','off','inherit'].includes(cp) ? cp : 'on';
        }catch(e){ document.getElementById('status').textContent='Failed to load channel'; document.getElementById('status').className='status error' }
        try{
          const mres = await fetch(`/api/admin/spaces/${spaceId}/members`, { credentials:'same-origin' }); const data = await mres.json();
          const tbody=document.getElementById('rows'); tbody.innerHTML='';
          (data.members||[]).forEach(m=>{
            const tr=document.createElement('tr'); const path=`/admin/channels/${spaceId}/user/${m.userId}`;
            tr.innerHTML = `<td>${m.userId}</td><td><a href=\"${path}\">${m.displayName||''}</a></td><td>${m.email||''}</td><td>${(m.roles||[]).join(', ')}</td><td><button class=\"btn danger\" data-action=\"remove\" data-user=\"${m.userId}\">Remove</button></td>`;
            tbody.appendChild(tr);
          });
          tbody.querySelectorAll('button[data-action="remove"]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{ const uid=Number(e.currentTarget.getAttribute('data-user')); if(!confirm('Remove member?')) return; await fetch(`/api/admin/spaces/${spaceId}/members/${uid}`, { method:'DELETE', headers: headers(), credentials:'same-origin' }); load(); })
          })
          // Update delete button state
          const delBtn = document.getElementById('deleteBtn'); const note = document.getElementById('delNote');
          const members = Array.isArray(data.members) ? data.members : [];
          if (members.length > 0) { delBtn.disabled = true; note.textContent = 'All members must be removed before deletion.'; }
          else { delBtn.disabled = false; note.textContent = 'No members detected; deletion is allowed.'; }
        }catch(e){
          const s=document.getElementById('status'); s.textContent='Failed to load members'; s.className='status error'
        }
      }
      async function doDelete(){
        if (!confirm('Delete this channel? This cannot be undone.')) return;
        const st = document.getElementById('deleteStatus');
        try{
          const res = await fetch(`/api/spaces/${spaceId}`, { method:'DELETE', headers: headers(), credentials:'same-origin' });
          if (!res.ok) throw new Error('failed');
          st.textContent='Deleted'; st.className='status ok';
          setTimeout(()=>{ window.location.href = '/admin/channels'; }, 600);
        }catch(e){ st.textContent='Failed to delete channel'; st.className='status error'; }
      }
      async function save(){
        try{
          const nameInput = document.getElementById('name');
          const policySel = document.getElementById('commentsPolicy');
          const rrEl = document.getElementById('requireReview');
          const body = { name: nameInput ? nameInput.value.trim() : '', commentsPolicy: policySel ? policySel.value : undefined };
          if (!rrEl.disabled) body.requireReview = !!rrEl.checked;
          await fetch(`/api/admin/spaces/${spaceId}`, { method:'PUT', headers: headers(), credentials:'same-origin', body: JSON.stringify(body) });
          const s=document.getElementById('status'); s.textContent='Saved'; s.className='status ok';
        } catch(e){ const s=document.getElementById('status'); s.textContent='Failed to save'; s.className='status error' }
      }
      async function addMember(){ const uid=Number(document.getElementById('addUserId').value); const roles=[...document.querySelectorAll('#rolesBox input[type=checkbox]')].filter(b=>b.checked).map(b=>b.getAttribute('data-role')); try{ await fetch(`/api/admin/spaces/${spaceId}/members`, { method:'POST', headers: headers(), credentials:'same-origin', body: JSON.stringify({ userId: uid, roles }) }); load(); }catch(e){ alert('Failed to add member') } }
      document.getElementById('saveBtn').addEventListener('click', save);
      document.getElementById('deleteBtn').addEventListener('click', doDelete);
      document.getElementById('addBtn').addEventListener('click', addMember);
      loadRoles().then(loadSite).then(load);
    </script>
  </body>
  </html>
