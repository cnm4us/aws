<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€¢ Settings</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1>Admin</h1>
      <a href="/admin/settings">Site Settings</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/groups">Groups</a>
      <a href="/admin/channels">Channels</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2>Site Settings</h2>
        <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input type="checkbox" id="allowGroupCreation" />
          Allow members to create groups
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
          <input type="checkbox" id="allowChannelCreation" />
          Allow members to create channels
        </label>
        <div style="height:8px"></div>
        <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input type="checkbox" id="requireGroupReview" />
          Require Group Review/Approval
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
          <input type="checkbox" id="requireChannelReview" />
          Require Channel Review/Approval
        </label>
        <button class="btn" id="saveBtn">Save Settings</button>
        <div class="status" id="status"></div>
      </div>
    </main>
    <script>
      const csrf = () => { const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/); return m?decodeURIComponent(m[1]):null };
      const headers = () => { const h={'Content-Type':'application/json'}; const t=csrf(); if(t) h['x-csrf-token']=t; return h };
      async function load() {
        try {
          const res = await fetch('/api/admin/site-settings', { credentials:'same-origin' });
          const data = await res.json();
          document.getElementById('allowGroupCreation').checked = !!data.allowGroupCreation;
          document.getElementById('allowChannelCreation').checked = !!data.allowChannelCreation;
          if ('requireGroupReview' in data) document.getElementById('requireGroupReview').checked = !!data.requireGroupReview;
          if ('requireChannelReview' in data) document.getElementById('requireChannelReview').checked = !!data.requireChannelReview;
        } catch (e) {
          document.getElementById('status').textContent = 'Failed to load settings';
          document.getElementById('status').className = 'status error';
        }
      }
      async function save() {
        const body = {
          allowGroupCreation: document.getElementById('allowGroupCreation').checked,
          allowChannelCreation: document.getElementById('allowChannelCreation').checked,
          requireGroupReview: document.getElementById('requireGroupReview').checked,
          requireChannelReview: document.getElementById('requireChannelReview').checked,
        };
        try {
          await fetch('/api/admin/site-settings', { method:'PUT', headers: headers(), credentials:'same-origin', body: JSON.stringify(body) });
          const s=document.getElementById('status'); s.textContent='Saved'; s.className='status ok';
        } catch (e) {
          const s=document.getElementById('status'); s.textContent='Failed to save'; s.className='status error';
        }
      }
      document.getElementById('saveBtn').addEventListener('click', save);
      load();
    </script>
  </body>
  </html>
