<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Publish Videos</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      table { border-collapse: collapse; width: 100%; max-width: 960px; }
      th, td { border: 1px solid #ddd; padding: 8px; }
      th { background: #f5f5f5; text-align: left; }
      button { padding: 0.3rem 0.6rem; }
      .muted { color: #666; }
    </style>
  </head>
  <body>
    <h2>Uploaded Videos</h2>
    <div style="margin: 0 0 1rem 0;">
      <label for="quality" style="margin-left:12px;">Quality:</label>
      <select id="quality">
        <option value="standard" selected>Standard</option>
        <option value="hq">High Quality</option>
      </select>
      <label for="sound" style="margin-left:12px;">Sound:</label>
      <select id="sound">
        <option value="original" selected>Original</option>
        <option value="normalize">Normalize (-16 LUFS)</option>
      </select>
      <input id="admintoken" type="password" placeholder="Admin token (optional)" style="margin-left:12px; padding:3px 6px;" />
    </div>
    <p class="muted" id="hint">Only showing latest 50 by default.</p>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Filename</th>
          <th>Size</th>
          <th>WxH</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
      const rows = document.getElementById('rows');

      function fmtBytes(n){
        if (!n && n !== 0) return '';
        const units = ['B','KB','MB','GB','TB'];
        let i=0, v = n;
        while (v >= 1024 && i < units.length-1) { v/=1024; i++; }
        return v.toFixed(1)+' '+units[i];
      }

      async function load(){
        let uid = null, authed = null;
        try { uid = localStorage.getItem('userId'); authed = localStorage.getItem('auth'); } catch {}
        // Require login to view/publish your uploads
        if (authed !== '1' || !uid) {
          rows.innerHTML = '';
          const hint = document.getElementById('hint');
          if (hint) hint.textContent = 'Please login to see and publish your uploads.';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" class="muted">Not logged in. <a href="/login">Login</a> or <a href="/register">Register</a>.</td>`;
          rows.appendChild(tr);
          return;
        }
        let url = '/api/uploads?limit=50&user_id=' + encodeURIComponent(uid);
        const res = await fetch(url);
        const data = await res.json();
        rows.innerHTML = '';
        data.forEach((u) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              ${u.id}
            </td>
            <td title="${u.s3_key}">
              ${u.original_filename}
            </td>
            <td>${fmtBytes(u.size_bytes)}</td>
            <td>${u.width||''}x${u.height||''}</td>
            <td>${u.status}</td>
            <td>
              ${u.status === 'uploaded' ? `<button data-id="${u.id}" data-action="publish">Publish</button>` : `<span class="muted">-</span>`}
              <button data-id="${u.id}" data-action="delete" style="margin-left:6px;">Delete</button>
            </td>
          `;
          rows.appendChild(tr);
        });
        const qualitySel = document.getElementById('quality');
        const soundSel = document.getElementById('sound');
        const adminToken = document.getElementById('admintoken');
        rows.querySelectorAll('button[data-id]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            const action = e.currentTarget.getAttribute('data-action');
            if (action === 'publish') {
              e.currentTarget.disabled = true;
              e.currentTarget.textContent = 'Publishing...';
              try {
                const quality = qualitySel.value;
                const sound = soundSel.value;
                const body = { id: Number(id), quality, sound };
                const headers = {'Content-Type':'application/json'};
                if (adminToken.value) headers['x-admin-token'] = adminToken.value;
                const resp = await fetch('/api/publish', { method:'POST', headers, body: JSON.stringify(body) });
                const json = await resp.json();
                if (!resp.ok) throw new Error(json.error || 'Failed');
              } catch (err) {
                alert('Publish failed: ' + err.message);
              } finally {
                await load();
              }
            } else if (action === 'delete') {
              if (!confirm('Delete this upload and all derived files? This cannot be undone.')) return;
              try {
                let uid = null; try { uid = localStorage.getItem('userId') } catch {}
                const headers = {'Content-Type':'application/json'};
                if (adminToken.value) headers['x-admin-token'] = adminToken.value;
                const resp = await fetch(`/api/uploads/${id}`, { method:'DELETE', headers, body: JSON.stringify({ userId: uid ? Number(uid) : null }) });
                const json = await resp.json().catch(()=>({}));
                if (!resp.ok) throw new Error(json && json.error || 'Failed');
              } catch (err) {
                alert('Delete failed: ' + err.message);
              } finally {
                await load();
              }
            }
          });
        });
      }

      load();
    </script>
  </body>
  </html>
