# Plan 38 — Watermark Posters + Title Image Intro (Optional Hold)

## Goal
1) **Apply the logo watermark to posters** generated by MediaConvert (poster at `t=0`), so the poster matches what viewers see at the start of playback.
2) Add a new production intro mode: **user-uploaded title image** that becomes frame `t=0` (the poster), with an optional “hold” duration (freeze) before the real video begins.

This plan intentionally keeps “poster = first frame of the mastered timeline”, so intros (freeze-first-frame or title image) automatically affect posters.

## Non-Goals
- No parametric SVG overlays for title text yet (that is a future plan).
- No intro-only lower thirds / animated graphics yet.
- No changes to feed/routing/publishing permissions.

## Current State
- Posters are generated by **MediaConvert** (FILE_GROUP_SETTINGS with `NameModifier: '_poster'`).
- Logo watermark is applied via MediaConvert ImageInserter to the video outputs, but we currently **skip watermarking posters**.
- We already support intro freeze-first-frame via ffmpeg mastering.

## Part A — Watermark Posters (MediaConvert)

### A1) Desired Behavior
- When a production has `logoUploadId + logoConfigSnapshot`, apply the same watermark to:
  - HLS/CMAF video outputs (already)
  - Poster jpg outputs (new)
- Poster timestamp stays at `t=0` (your choice).

### A2) Implementation Sketch
- In `src/services/productionRunner.ts`, poster outputs are created in FILE_GROUP_SETTINGS.
- Update the watermark logic to also add ImageInserter settings for poster outputs.
  - Easiest: ensure the poster `VideoDescription` gets the same `VideoPreprocessors.ImageInserter` config.
  - Keep the existing “no watermark on posters” behavior behind a simple flag:
    - default **enabled** once shipped, or
    - env flag `MC_WATERMARK_POSTERS=1` (optional; decide in open questions).

### A3) Validation
- Production with logo -> poster jpg includes logo.
- Production without logo -> poster unchanged.
- Production with intro -> poster shows intro frame (t=0) and watermark on top.

## Part B — Title Image Intro (Optional Hold)

### B1) Intro Config Shape
Extend `productions.config.intro` to support a second `kind`:

```json
{
  "intro": {
    "kind": "title_image",
    "uploadId": 123,
    "holdSeconds": 4
  }
}
```

Notes:
- `holdSeconds` can be `null`/`0` to mean “no hold” (instant transition).
- `uploadId` references an upload row of `kind='logo'` or a new `kind='image'` (open question).
  - For now: reuse `kind='logo'` uploads for title images (fastest), but consider renaming later.

### B2) Producer UI
On `/produce?upload=...`:
- Add “Title Page (optional)” section:
  - Choose title image (picker route-based like audio/logo pickers).
  - Hold duration: None | 2s | 3s | 4s | 5s (or a small set).
  - Clear selection.
- Persist selection in URL:
  - `titleUploadId=123`
  - `titleHoldSeconds=4`

### B3) Mastering Pipeline (ffmpeg)
Create a generalized “intro master” pipeline:
- If `intro.kind = freeze_first_frame`: current behavior (already implemented).
- If `intro.kind = title_image`:
  - Download the image upload.
  - Create a video segment of `holdSeconds` duration from the still image (or 1 frame if hold=0).
  - Concatenate it before the original video.
  - Delay original audio by `holdSeconds` (same as freeze-first-frame).
  - Output an MP4 in `intro-title/<date>/<productionUlid>/<uuid>/<originalLeaf>`

Key constraints:
- Preserve output orientation/resolution expectations:
  - Scale/pad the title image to match the video’s frame size (no rotation changes).
  - Use letterbox/pillarbox to avoid cropping by default (recommended).

### B4) Media Jobs Orchestration
Use the existing DB media jobs:
- For “intro only”: enqueue `video_master_v1` with either:
  - `intro.kind='freeze_first_frame'` (already) OR
  - `intro.kind='title_image'` (new)
- For “intro + music”: `audio_master_v1` should:
  1) intro master (title or freeze)
  2) audio mix/replace + opener cutoff/normalize
  3) MediaConvert packaging

This keeps the number of MediaConvert profiles and packaging logic unchanged.

## Manual Test Matrix
1) No intro, logo -> poster includes logo.
2) Freeze intro 4s, logo -> poster shows frozen first frame + logo.
3) Title image intro hold 4s, no music, logo -> poster shows title image + logo; first 4s playback matches poster; then real video begins.
4) Title image intro hold 4s + Opener Cutoff + logo -> opener starts at 0, cutoff t is measured after the hold (speech starts later); logo appears on poster and video.

## Decisions (captured)
1) Title image upload type:
   - Add a first-class image kind plus a role filter (so we don’t create a new `kind` per image use-case).
   - Proposed: `uploads.kind='image'` and a new nullable column like `uploads.image_role` (e.g. `title_page`, `lower_third`, `overlay`, `slide_background`).
2) Hold seconds allowed set:
   - `0/2/3/4/5`
3) Watermark posters rollout:
   - Behind an env flag: `MC_WATERMARK_POSTERS=1`
4) Title image fit mode:
   - Start with “cover + crop”

## Open Questions (remaining)
1) Role naming for the first implementation:
   - Should the title image role be `title_page` (recommended for clarity) or `slide_background` (your suggested direction)?
