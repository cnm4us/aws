<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Space Moderation</title>
    <link rel="stylesheet" href="/admin-nav.css" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; }
      h1 { margin: 0 0 0.5rem 0; }
      .muted { color: #666; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { border: 1px solid #e5e7eb; padding: 0.5rem; font-size: 14px; vertical-align: top; }
      th { background: #f8fafc; text-align: left; }
      .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; padding:0.35rem 0.6rem; border-radius:6px; cursor:pointer; font-weight:600; }
      .btn.approve { border-color:#0ea5e9; color:#0b5cff; }
      .btn.reject { border-color:#ef4444; color:#b91c1c; }
      .row-actions { display:flex; gap:0.5rem; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    </style>
  </head>
  <body>
    <nav class="sidebar">
      <h1 id="navTitle">Space</h1>
      <a id="navSettings" href="#">Settings</a>
      <a id="navMembers" href="#">Members</a>
      <a id="navModeration" href="#">Moderation</a>
    </nav>
    <main class="main">
    <div class="section">
      <h2 id="spaceNameTitle">Space</h2>
    </div>
    <header>
      <h1>Moderation Queue <span id="spaceLabel" class="muted"></span></h1>
      <div class="muted">Pending publications requiring approval</div>
    </header>
    <section>
      <table>
        <thead>
          <tr>
            <th>Publication</th>
            <th>Production</th>
            <th>Asset</th>
            <th>Requester</th>
            <th>Requested At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="queueBody">
          <tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </section>

    <script>
      (function() {
        function parseContext() {
          var p = location.pathname;
          var m = p.match(/^\/(spaces|groups|channels)\/(\d+)\/(moderation|admin)/);
          if (!m) return { type: 'spaces', id: null };
          return { type: m[1], id: Number(m[2]) };
        }
        var ctx = parseContext();
        var sid = ctx.id;
        var label = document.getElementById('spaceLabel');
        if (label && sid) label.textContent = '(space #' + sid + ')';
        // Nav
        (function setNav(){
          var base = '/' + ctx.type + '/' + sid;
          var label = ctx.type === 'spaces' ? 'Space' : ctx.type === 'groups' ? 'Group' : 'Channel';
          var title = document.getElementById('navTitle'); if (title) title.textContent = label + ' Admin';
          var s = document.getElementById('navSettings'); if (s) s.href = base + '/admin/settings';
          var m = document.getElementById('navMembers'); if (m) m.href = base + '/admin/members';
          var mod = document.getElementById('navModeration'); if (mod) mod.href = base + '/moderation';
        })();
        // Load space name
        (async function loadSpaceTitle(){
          try{
            const r = await fetch('/api/spaces/' + sid + '/settings', { credentials:'same-origin' });
            if (!r.ok) return;
            const d = await r.json();
            var t = document.getElementById('spaceNameTitle'); if (t) t.textContent = d && d.name ? d.name : (ctx.type === 'groups' ? 'Group' : ctx.type === 'channels' ? 'Channel' : 'Space');
          }catch(e){}
        })();

        async function fetchQueue() {
          const res = await fetch('/api/spaces/' + sid + '/moderation/queue', { credentials: 'include' });
          if (!res.ok) throw new Error('failed to load queue');
          return res.json();
        }

        function fmtDate(s) {
          if (!s) return '-';
          try { return new Date(s).toLocaleString(); } catch { return String(s); }
        }

        function getCsrf() {
          const m = document.cookie.match(/(?:^|;)\s*csrf=([^;]+)/);
          return m ? decodeURIComponent(m[1]) : null;
        }
        async function doAction(id, action) {
          const url = action === 'approve'
            ? '/api/publications/' + id + '/approve'
            : '/api/publications/' + id + '/reject';
          const headers = { 'Content-Type': 'application/json' };
          const csrf = getCsrf();
          if (csrf) headers['x-csrf-token'] = csrf;
          const res = await fetch(url, { method: 'POST', headers, credentials: 'include', body: JSON.stringify({}) });
          if (!res.ok) {
            try { const j = await res.json(); throw new Error(j?.error || 'action_failed'); } catch (e) { throw new Error('action failed'); }
          }
        }

        async function render() {
          const body = document.getElementById('queueBody');
          if (!sid) { body.innerHTML = '<tr><td colspan="5">Invalid space id.</td></tr>'; return; }
          try {
            const data = await fetchQueue();
            const items = Array.isArray(data.items) ? data.items : [];
            if (!items.length) {
              body.innerHTML = '<tr><td colspan="5" class="muted">No pending items.</td></tr>';
              return;
            }
            body.innerHTML = '';
            items.forEach(function(it) {
              var tr = document.createElement('tr');
              var asset = it.upload && (it.upload.modified_filename || it.upload.original_filename) || '(upload #' + it.publication.upload_id + ')';
              var prod = it.publication.production_id != null ? ('#' + it.publication.production_id) : '-';
              var requester = it.requester && (it.requester.displayName || it.requester.email) || '-';
              tr.innerHTML = [
                '<td class="mono">#' + it.publication.id + '</td>',
                '<td class="mono">' + prod + '</td>',
                '<td>' + asset + '</td>',
                '<td>' + requester + '</td>',
                '<td>' + fmtDate(it.publication.created_at) + '</td>',
                '<td class="row-actions">'
                  + '<button data-id="' + it.publication.id + '" data-act="approve" class="btn approve">Approve</button>'
                  + '<button data-id="' + it.publication.id + '" data-act="reject" class="btn reject">Reject</button>'
                + '</td>'
              ].join('');
              body.appendChild(tr);
            });
            body.addEventListener('click', async function(e) {
              var t = e.target;
              if (!(t instanceof HTMLElement)) return;
              var act = t.getAttribute('data-act');
              var id = t.getAttribute('data-id');
              if (!act || !id) return;
              try {
                t.setAttribute('disabled', 'true');
                await doAction(Number(id), act);
                await render();
              } catch (err) {
                alert('Failed: ' + (err && err.message ? err.message : String(err)));
              } finally {
                t.removeAttribute('disabled');
              }
            }, { once: true });
          } catch (err) {
            body.innerHTML = '<tr><td colspan="5">Failed to load queue.</td></tr>';
          }
        }
        render();
      })();
    </script>
    </main>
  </body>
  </html>
