<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin â€¢ Add User</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1>Admin</h1>
      <a href="/admin/settings">Site Settings</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/groups">Groups</a>
      <a href="/admin/channels">Channels</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2>Add User</h2>
        <div class="field">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="email@example.com" />
        </div>
        <div class="field">
          <label for="displayName">Display Name</label>
          <input id="displayName" type="text" placeholder="Display name" />
        </div>
        <div class="field">
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Set initial password" />
        </div>
        <div class="field">
          <label for="phoneNumber">Phone</label>
          <input id="phoneNumber" type="text" placeholder="Optional" />
        </div>
        <div class="field">
          <label for="verificationLevel">Verification Level</label>
          <input id="verificationLevel" type="number" min="0" />
        </div>
        <div class="field">
          <label for="kycStatus">KYC Status</label>
          <select id="kycStatus">
            <option value="none">none</option>
            <option value="pending">pending</option>
            <option value="verified">verified</option>
            <option value="rejected">rejected</option>
          </select>
        </div>
        <div class="field">
          <label for="canCreateGroup">Can Create Group (override)</label>
          <select id="canCreateGroup">
            <option value="">inherit</option>
            <option value="true">allow</option>
            <option value="false">deny</option>
          </select>
        </div>
        <div class="field">
          <label for="canCreateChannel">Can Create Channel (override)</label>
          <select id="canCreateChannel">
            <option value="">inherit</option>
            <option value="true">allow</option>
            <option value="false">deny</option>
          </select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="createBtn">Add User</button>
          <a class="btn" href="/admin/users">Cancel</a>
        </div>
        <div class="status" id="status"></div>
      </div>
    </main>
    <script>
      const csrf=()=>{const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/);return m?decodeURIComponent(m[1]):null};
      const headers=()=>{const h={'Content-Type':'application/json'};const t=csrf();if(t)h['x-csrf-token']=t;return h};
      async function create(){
        const email=document.getElementById('email').value.trim();
        const displayName=document.getElementById('displayName').value.trim();
        const password=document.getElementById('password').value;
        const phoneNumber=document.getElementById('phoneNumber').value.trim();
        const verificationLevel=Number(document.getElementById('verificationLevel').value||0);
        const kycStatus=document.getElementById('kycStatus').value;
        const cgg=document.getElementById('canCreateGroup').value; const canCreateGroup = cgg===''? null : cgg==='true';
        const cgc=document.getElementById('canCreateChannel').value; const canCreateChannel = cgc===''? null : cgc==='true';
        const body={ email, displayName, password, phoneNumber, verificationLevel, kycStatus, canCreateGroup, canCreateChannel };
        try{
          const res = await fetch('/api/admin/users', { method:'POST', headers: headers(), credentials:'same-origin', body: JSON.stringify(body) });
          if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err?.detail||err?.error||'Failed'); }
          const user = await res.json();
          window.location.href = `/admin/users/${user.id}`;
        }catch(e){ const s=document.getElementById('status'); s.textContent=e?.message||'Failed to create user'; s.className='status error'; }
      }
      document.getElementById('createBtn').addEventListener('click', create);
    </script>
  </body>
  </html>
