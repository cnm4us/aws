<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin • Group User Roles</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1>Admin</h1>
      <a href="/admin/settings">Site Settings</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/groups">Groups</a>
      <a href="/admin/channels">Channels</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2 id="title">Group Roles</h2>
        <div id="rolesBox" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"></div>
        <button class="btn" id="saveBtn">Save User Roles</button>
        <div class="status" id="status"></div>
      </div>
    </main>
    <script>
      const m = location.pathname.match(/\/admin\/groups\/(\d+)\/user\/(\d+)/); const spaceId=m?Number(m[1]):null; const userId=m?Number(m[2]):null;
      const csrf=()=>{const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/);return m?decodeURIComponent(m[1]):null}; const headers=()=>{const h={'Content-Type':'application/json'}; const t=csrf(); if(t) h['x-csrf-token']=t; return h };
      let allRoles=[]; let currentRoles=new Set();
      function render() {
        const c=document.getElementById('rolesBox'); c.innerHTML='';
        const spaceRoles = allRoles.filter(ro => {
          const n = String(ro.name||'');
          return /^space_/.test(n);
        });
        spaceRoles.forEach(r=>{
          const id=`role_${r.name}`; const label=document.createElement('label'); label.style.display='flex'; label.style.gap='6px'; label.style.alignItems='center';
          const checked = currentRoles.has(r.name) ? 'checked' : '';
          label.innerHTML = `<input type=\"checkbox\" data-role=\"${r.name}\" ${checked}/> ${r.name}`;
          c.appendChild(label);
        })
      }
      async function load(){
        try{
          const [rolesRes, currRes, spaceRes] = await Promise.all([
            fetch('/api/admin/roles', { credentials:'same-origin' }),
            fetch(`/api/admin/spaces/${spaceId}/users/${userId}/roles`, { credentials:'same-origin' }),
            fetch(`/api/admin/spaces/${spaceId}`, { credentials:'same-origin' })
          ]);
          const rolesJson = await rolesRes.json(); allRoles = rolesJson.roles||[];
          const currJson = await currRes.json(); currentRoles = new Set(currJson.roles||[]);
          const space = await spaceRes.json(); document.getElementById('title').textContent = `Group #${space.id} • User #${userId}`;
          render();
        }catch(e){ const s=document.getElementById('status'); s.textContent='Failed to load'; s.className='status error' }
      }
      async function save(){
        const roles=[...document.querySelectorAll('#rolesBox input[type=checkbox]')].filter(b=>b.checked).map(b=>b.getAttribute('data-role'));
        try{ await fetch(`/api/admin/spaces/${spaceId}/users/${userId}/roles`, { method:'PUT', headers: headers(), credentials:'same-origin', body: JSON.stringify({ roles }) }); const s=document.getElementById('status'); s.textContent='Saved'; s.className='status ok' }catch(e){ const s=document.getElementById('status'); s.textContent='Failed to save'; s.className='status error' }
      }
      document.getElementById('saveBtn').addEventListener('click', save);
      load();
    </script>
  </body>
  </html>
