<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Site Admin</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; background:#f5f7fa; color:#222; }
      h1 { margin-top: 0; }
      section { background:#fff; border:1px solid #dce1eb; border-radius:10px; padding:1.5rem; margin-bottom:1.5rem; box-shadow:0 4px 18px rgba(0,0,0,0.08); }
      h2 { margin-top:0; }
      label { display:block; font-weight:600; margin-bottom:0.5rem; }
      input[type="text"], input[type="number"], input[type="email"], textarea, select {
        width:100%; max-width:320px; border:1px solid #c5ccda; border-radius:8px; padding:0.6rem 0.75rem; font-size:15px;
        background:#fafbff;
      }
      button { border:none; background:#0059d6; color:#fff; padding:0.6rem 1.2rem; border-radius:8px; font-weight:600; cursor:pointer; box-shadow:0 3px 12px rgba(0,89,214,0.25); }
      button:disabled { background:#93a5c7; cursor:not-allowed; box-shadow:none; }
      table { width:100%; border-collapse:collapse; margin-top:1rem; }
      th, td { border:1px solid #e3e8f3; padding:0.6rem; font-size:14px; }
      th { background:#f0f3fa; text-align:left; }
      .row { margin-bottom:1rem; }
      .inline { display:flex; gap:0.6rem; align-items:center; }
      .label-inline { font-weight:500; }
      .status { margin-top:0.5rem; font-size:14px; }
      .status.ok { color:#2e7d32; }
      .status.error { color:#c62828; }
      .chips { display:flex; flex-wrap:wrap; gap:0.4rem; }
      .chip { background:#eef2ff; border:1px solid #cfd7f3; border-radius:14px; padding:0.2rem 0.75rem; font-size:13px; }
      .danger { background:#d32f2f; }
    </style>
  </head>
  <body>
    <h1>Site Administration</h1>

    <section id="siteSettings">
      <h2>Site Settings</h2>
      <div class="row">
        <label class="inline">
          <input type="checkbox" id="allowGroupCreation" />
          <span class="label-inline">Allow members to create groups</span>
        </label>
      </div>
      <div class="row">
        <label class="inline">
          <input type="checkbox" id="allowChannelCreation" />
          <span class="label-inline">Allow members to create channels</span>
        </label>
      </div>
      <button id="saveSiteSettings">Save Settings</button>
      <div class="status" id="siteSettingsStatus"></div>
    </section>

    <section id="userCapabilities">
      <h2>User Capabilities</h2>
      <div class="row">
        <label for="userId">User ID</label>
        <input type="number" id="userId" placeholder="Enter user ID" />
      </div>
      <button id="loadUser">Load User</button>
      <div class="status" id="userStatus"></div>

      <div id="userDetails" style="display:none; margin-top:1rem;">
        <h3>Overrides</h3>
        <div class="row inline">
          <label class="inline">
            <input type="checkbox" id="overrideGroup" />
            <span class="label-inline">Override group creation</span>
          </label>
          <select id="overrideGroupValue">
            <option value="null">Inherit</option>
            <option value="true">Allow</option>
            <option value="false">Deny</option>
          </select>
        </div>
        <div class="row inline">
          <label class="inline">
            <input type="checkbox" id="overrideChannel" />
            <span class="label-inline">Override channel creation</span>
          </label>
          <select id="overrideChannelValue">
            <option value="null">Inherit</option>
            <option value="true">Allow</option>
            <option value="false">Deny</option>
          </select>
        </div>
        <button id="saveOverrides">Save Overrides</button>
        <div class="status" id="overrideStatus"></div>

        <h3 style="margin-top:1.5rem;">Effective Permissions</h3>
        <div class="row">
          <strong>Can create group:</strong> <span id="effectiveGroup"></span>
        </div>
        <div class="row">
          <strong>Can create channel:</strong> <span id="effectiveChannel"></span>
        </div>
      </div>
    </section>

    <section id="spaceManagement">
      <h2>Space Management</h2>
      <div class="row">
        <label for="spaceId">Space ID</label>
        <input type="number" id="spaceId" placeholder="Enter space ID" />
      </div>
      <button id="loadMembers">Load Members</button>
      <div class="status" id="spaceStatus"></div>

      <div id="spaceDetails" style="display:none;">
        <h3>Members</h3>
        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Display Name</th>
              <th>Email</th>
              <th>Roles</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="memberRows"></tbody>
        </table>

        <h3 style="margin-top:1.5rem;">Add Member</h3>
        <div class="row">
          <label for="addUserId">User ID to add</label>
          <input type="number" id="addUserId" placeholder="Enter user ID" />
        </div>
        <div class="row">
          <label for="addRoles">Roles (optional, comma separated)</label>
          <input type="text" id="addRoles" placeholder="e.g., group_member,group_admin" />
        </div>
        <button id="addMember">Add Member</button>
        <div class="status" id="addMemberStatus"></div>

        <h3 style="margin-top:1.5rem;">Invite Member</h3>
        <div class="row">
          <label for="inviteUserId">User ID to invite</label>
          <input type="number" id="inviteUserId" placeholder="Enter user ID" />
        </div>
        <button id="inviteMember">Send Invitation</button>
        <div class="status" id="inviteStatus"></div>

        <h3 style="margin-top:1.5rem;">Pending Invitations</h3>
        <table>
          <thead>
            <tr>
              <th>User ID</th>
              <th>Status</th>
              <th>Invited</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invitationRows"></tbody>
        </table>
      </div>
    </section>

    <section id="createSpace">
      <h2>Create Space</h2>
      <div class="row">
        <label for="newSpaceType">Type</label>
        <select id="newSpaceType">
          <option value="group" selected>Group</option>
          <option value="channel">Channel</option>
        </select>
      </div>
      <div class="row">
        <label for="newSpaceName">Name</label>
        <input type="text" id="newSpaceName" placeholder="Enter name" />
      </div>
      <button id="createSpaceBtn">Create Space</button>
      <div class="status" id="createSpaceStatus"></div>
    </section>

    <section id="existingSpaces">
      <h2>Existing Spaces</h2>
      <div class="status" id="spacesStatus"></div>
      <h3>Groups</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Slug</th>
            <th>Owner ID</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody id="groupsTable"></tbody>
      </table>
      <h3 style="margin-top:1.5rem;">Channels</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Slug</th>
            <th>Owner ID</th>
            <th>Link</th>
          </tr>
        </thead>
        <tbody id="channelsTable"></tbody>
      </table>
    </section>

    <script>
      console.log('[admin] script bootstrap');
      const csrfToken = () => {
        const m = document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : null;
      };

      const authHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        const csrf = csrfToken();
        if (csrf) headers['x-csrf-token'] = csrf;
        return headers;
      };

      const apiRequest = async (input, init = {}) => {
        const opts = { credentials: 'same-origin', ...init };
        const res = await fetch(input, opts);
        if (!res.ok) {
          let message = `Request failed (${res.status})`;
          try {
            const data = await res.json();
            if (data && typeof data === 'object') {
              if (data.detail) message = data.detail;
              else if (data.error) message = data.error;
              else message = JSON.stringify(data);
            }
          } catch {
            try {
              const text = await res.text();
              if (text) message = text;
            } catch {}
          }
          throw new Error(message);
        }
        return res;
      };

      const siteSettingsStatus = document.getElementById('siteSettingsStatus');
      const userStatus = document.getElementById('userStatus');
      const overrideStatus = document.getElementById('overrideStatus');
      const spaceStatus = document.getElementById('spaceStatus');
      const addMemberStatus = document.getElementById('addMemberStatus');
      const inviteStatus = document.getElementById('inviteStatus');
      const spacesStatus = document.getElementById('spacesStatus');

      async function loadSiteSettings(){
        console.log('[admin] loadSiteSettings');
        console.log("[admin] loadSiteSettings start");
        try {
          const res = await apiRequest('/api/admin/site-settings');
          const data = await res.json();
          console.log('[admin] site settings', data);
          document.getElementById('allowGroupCreation').checked = data.allowGroupCreation;
          document.getElementById('allowChannelCreation').checked = data.allowChannelCreation;
        } catch (err){
          console.error('[admin] loadSiteSettings error', err);
          siteSettingsStatus.textContent = `Failed to load site settings. ${err?.message || ''}`;
          siteSettingsStatus.className = 'status error';
        }
      }

      async function saveSiteSettings(){
        siteSettingsStatus.textContent = '';
        try {
          const body = {
            allowGroupCreation: document.getElementById('allowGroupCreation').checked,
            allowChannelCreation: document.getElementById('allowChannelCreation').checked,
          };
          console.log('[admin] saveSiteSettings submit', body);
          await apiRequest('/api/admin/site-settings', {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify(body),
          });
          console.log('[admin] saveSiteSettings success');
          siteSettingsStatus.textContent = 'Saved.';
          siteSettingsStatus.className = 'status ok';
        } catch (err){
          console.error('[admin] saveSiteSettings error', err);
          siteSettingsStatus.textContent = `Failed to save site settings. ${err?.message || ''}`;
          siteSettingsStatus.className = 'status error';
        }
      }

      document.getElementById('saveSiteSettings').addEventListener('click', saveSiteSettings);
      console.log('[admin] saveSiteSettings handler ready');

      let currentUserId = null;
      let currentOverrides = null;

      async function loadUser(){
        console.log('[admin] loadUser click');
        userStatus.textContent = '';
        overrideStatus.textContent = '';
        const id = Number(document.getElementById('userId').value);
        if (!Number.isFinite(id) || id <= 0) {
          console.warn('[admin] loadUser invalid id', id);
          userStatus.textContent = 'Enter a valid user ID.';
          userStatus.className = 'status error';
          return;
        }
        try {
          const res = await apiRequest(`/api/admin/users/${id}/capabilities`);
          const data = await res.json();
          console.log('[admin] loadUser response', data);
          currentUserId = id;
          currentOverrides = data.overrides;
          document.getElementById('userDetails').style.display = 'block';

          const overrideGroup = document.getElementById('overrideGroup');
          const overrideGroupValue = document.getElementById('overrideGroupValue');
          const overrideChannel = document.getElementById('overrideChannel');
          const overrideChannelValue = document.getElementById('overrideChannelValue');

          overrideGroup.checked = currentOverrides.canCreateGroup !== null;
          overrideGroupValue.value = currentOverrides.canCreateGroup === null ? 'null' : currentOverrides.canCreateGroup ? 'true' : 'false';

          overrideChannel.checked = currentOverrides.canCreateChannel !== null;
          overrideChannelValue.value = currentOverrides.canCreateChannel === null ? 'null' : currentOverrides.canCreateChannel ? 'true' : 'false';

          document.getElementById('effectiveGroup').textContent = data.effective.canCreateGroup ? 'Yes' : 'No';
          document.getElementById('effectiveChannel').textContent = data.effective.canCreateChannel ? 'Yes' : 'No';

          userStatus.textContent = 'Loaded.';
          userStatus.className = 'status ok';
        } catch (err){
          console.error('[admin] loadUser error', err);
          currentUserId = null;
          document.getElementById('userDetails').style.display = 'none';
          userStatus.textContent = `Failed to load user. ${err?.message || ''}`;
          userStatus.className = 'status error';
        }
      }

      document.getElementById('loadUser').addEventListener('click', loadUser);
      console.log('[admin] loadUser handler ready');

      async function saveOverrides(){
        console.log('[admin] saveOverrides click');
        overrideStatus.textContent = '';
        if (!currentUserId) {
          overrideStatus.textContent = 'Load a user first.';
          overrideStatus.className = 'status error';
          return;
        }
        try {
          const body = {};
          const og = document.getElementById('overrideGroup');
          const ogv = document.getElementById('overrideGroupValue');
          body.canCreateGroup = og.checked ? (ogv.value === 'null' ? null : ogv.value === 'true') : null;
          console.log('[admin] saveOverrides payload start', body);

          const oc = document.getElementById('overrideChannel');
          const ocv = document.getElementById('overrideChannelValue');
          body.canCreateChannel = oc.checked ? (ocv.value === 'null' ? null : ocv.value === 'true') : null;
          console.log('[admin] saveOverrides payload final', body);

          const res = await apiRequest(`/api/admin/users/${currentUserId}/capabilities`, {
            method: 'PUT',
            headers: authHeaders(),
            body: JSON.stringify(body),
          });
          const data = await res.json();
          console.log('[admin] saveOverrides success', data);
          overrideStatus.textContent = 'Overrides saved.';
          overrideStatus.className = 'status ok';
          document.getElementById('effectiveGroup').textContent = data.effective.canCreateGroup ? 'Yes' : 'No';
          document.getElementById('effectiveChannel').textContent = data.effective.canCreateChannel ? 'Yes' : 'No';
        } catch (err){
          overrideStatus.textContent = `Failed to save overrides. ${err?.message || ''}`;
          overrideStatus.className = 'status error';
        }
      }

      document.getElementById('saveOverrides').addEventListener('click', saveOverrides);
      console.log('[admin] saveOverrides handler ready');

      let currentSpaceId = null;

      async function loadMembers(){
        console.log('[admin] loadMembers click');
        spaceStatus.textContent = '';
        const id = Number(document.getElementById('spaceId').value);
        if (!Number.isFinite(id) || id <= 0) {
          console.warn('[admin] loadMembers invalid id', id);
          spaceStatus.textContent = 'Enter a valid space ID.';
          spaceStatus.className = 'status error';
          return;
        }
        try {
          const res = await apiRequest(`/api/admin/spaces/${id}/members`);
          const data = await res.json();
          console.log('[admin] loadMembers response', data);
          currentSpaceId = id;
          document.getElementById('spaceDetails').style.display = 'block';
          renderMembers(data.members || []);
          await loadInvitations();
          spaceStatus.textContent = 'Loaded members.';
          spaceStatus.className = 'status ok';
        } catch (err){
          console.error('[admin] loadMembers error', err);
          currentSpaceId = null;
          document.getElementById('spaceDetails').style.display = 'none';
          spaceStatus.textContent = `Failed to load members. ${err?.message || ''}`;
          spaceStatus.className = 'status error';
        }
      }

      document.getElementById('loadMembers').addEventListener('click', loadMembers);
      console.log('[admin] loadMembers handler ready');

      function renderMembers(members){
        console.log('[admin] renderMembers', members?.length || 0);
        const tbody = document.getElementById('memberRows');
        tbody.innerHTML = '';
        members.forEach((m) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.userId}</td>
            <td>${m.displayName || ''}</td>
            <td>${m.email || ''}</td>
            <td><div class="chips">${m.roles.map(r => `<span class="chip">${r}</span>`).join(' ')}</div></td>
            <td>
              <button data-action="remove" data-user="${m.userId}" class="danger">Remove</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button[data-action="remove"]').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const uid = Number(e.currentTarget.getAttribute('data-user'));
            if (!currentSpaceId) return;
            if (!confirm('Remove member from space?')) return;
            try {
              await apiRequest(`/api/admin/spaces/${currentSpaceId}/members/${uid}`, {
                method: 'DELETE',
                headers: authHeaders(),
              });
              await loadMembers();
            } catch (err){
              alert(`Failed to remove member: ${err?.message || ''}`);
            }
          });
        });
      }

      async function loadInvitations(){
        if (!currentSpaceId) return;
        console.log('[admin] loadInvitations for space', currentSpaceId);
        try {
          const res = await apiRequest(`/api/admin/spaces/${currentSpaceId}/invitations`);
          const data = await res.json();
          console.log('[admin] loadInvitations response', data);
          const tbody = document.getElementById('invitationRows');
          tbody.innerHTML = '';
          (data.invitations || []).forEach((inv) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${inv.userId}</td>
              <td>${inv.status}</td>
              <td>${inv.createdAt || ''}</td>
              <td>
                ${inv.status === 'pending' ? `<button data-action="revoke" data-user="${inv.userId}" class="danger">Revoke</button>` : ''}
              </td>
            `;
            tbody.appendChild(tr);
          });
          tbody.querySelectorAll('button[data-action="revoke"]').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const uid = Number(e.currentTarget.getAttribute('data-user'));
              try {
                await apiRequest(`/api/admin/spaces/${currentSpaceId}/invitations/${uid}`, {
                  method: 'DELETE',
                  headers: authHeaders()
                });
                await loadInvitations();
              } catch (err){
                alert(`Failed to revoke invitation: ${err?.message || ''}`);
              }
            });
          });
        } catch (err){
          console.error('[admin] loadInvitations error', err);
          document.getElementById('invitationRows').innerHTML = '<tr><td colspan="4">Failed to load invitations.</td></tr>';
        }
      }

      document.getElementById('addMember').addEventListener('click', async () => {
        console.log('[admin] addMember click');
        addMemberStatus.textContent = '';
        addMemberStatus.className = 'status';
        if (!currentSpaceId) {
          addMemberStatus.textContent = 'Load a space first.';
          addMemberStatus.className = 'status error';
          return;
        }
        const uid = Number(document.getElementById('addUserId').value);
        if (!Number.isFinite(uid) || uid <= 0) {
          addMemberStatus.textContent = 'Enter a valid user ID.';
          addMemberStatus.className = 'status error';
          return;
        }
        const rolesInput = document.getElementById('addRoles').value;
        const roles = rolesInput
          .split(',')
          .map((r) => r.trim())
          .filter((r) => r.length > 0);
        try {
          const body = { userId: uid };
          if (roles.length) body.roles = roles;
          await apiRequest(`/api/admin/spaces/${currentSpaceId}/members`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(body),
          });
          addMemberStatus.textContent = 'Member added to space.';
          addMemberStatus.className = 'status ok';
          document.getElementById('addUserId').value = '';
          document.getElementById('addRoles').value = '';
          await loadMembers();
        } catch (err){
          console.error('[admin] addMember error', err);
          const message = err?.message || 'Failed to add member.';
          addMemberStatus.textContent = message;
          addMemberStatus.className = 'status error';
        }
      });

      document.getElementById('inviteMember').addEventListener('click', async () => {
        console.log('[admin] inviteMember click');
        inviteStatus.textContent = '';
        if (!currentSpaceId) {
          inviteStatus.textContent = 'Load a space first.';
          inviteStatus.className = 'status error';
          return;
        }
        const uid = Number(document.getElementById('inviteUserId').value);
        if (!Number.isFinite(uid) || uid <= 0) {
          inviteStatus.textContent = 'Enter a valid user ID.';
          inviteStatus.className = 'status error';
          return;
        }
        try {
          await apiRequest(`/api/admin/spaces/${currentSpaceId}/invitations`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ userId: uid })
          });
          inviteStatus.textContent = 'Invitation sent.';
          inviteStatus.className = 'status ok';
          document.getElementById('inviteUserId').value = '';
          await loadInvitations();
        } catch (err){
          console.error('[admin] inviteMember error', err);
          inviteStatus.textContent = `Failed to send invitation. ${err?.message || ''}`;
          inviteStatus.className = 'status error';
        }
      });

      async function loadSpaces(){
        console.log('[admin] loadSpaces start');
        spacesStatus.textContent = '';
        try {
          const res = await apiRequest('/api/admin/spaces');
          const data = await res.json();
          console.log('[admin] loadSpaces response', data);
          const groupsTbody = document.getElementById('groupsTable');
          const channelsTbody = document.getElementById('channelsTable');
          groupsTbody.innerHTML = '';
          channelsTbody.innerHTML = '';
          data.spaces.forEach((space) => {
            const tr = document.createElement('tr');
            const link = space.type === 'group' ? `/groups/${space.slug}` : `/channels/${space.slug}`;
            tr.innerHTML = `
              <td>${space.id}</td>
              <td>${space.name || ''}</td>
              <td>${space.slug}</td>
              <td>${space.ownerUserId ?? ''}</td>
              <td><a href="${link}" target="_blank">View</a></td>
            `;
            if (space.type === 'group') groupsTbody.appendChild(tr);
            else channelsTbody.appendChild(tr);
          });
        } catch (err){
          console.error('[admin] loadSpaces error', err);
          spacesStatus.textContent = `Failed to load spaces. ${err?.message || ''}`;
          spacesStatus.className = 'status error';
        }
      }

      loadSiteSettings();
      loadSpaces();

      document.getElementById('createSpaceBtn').addEventListener('click', async () => {
        console.log('[admin] createSpace click');
        const statusEl = document.getElementById('createSpaceStatus');
        statusEl.textContent = '';
        const type = document.getElementById('newSpaceType').value;
        const name = document.getElementById('newSpaceName').value.trim();
        console.log('[admin] createSpace values', { type, name });
        if (!name) {
          statusEl.textContent = 'Enter a name.';
          statusEl.className = 'status error';
          return;
        }
        try {
          const res = await apiRequest('/api/spaces', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ type, name })
          });
          const data = await res.json();
          console.log('[admin] createSpace response', data);
          statusEl.textContent = `Created ${type} space with id ${data.space.id} (slug: ${data.space.slug}).`;
          statusEl.className = 'status ok';
          document.getElementById('newSpaceName').value = '';
          await loadSpaces();
        } catch (err){
          console.error('[admin] createSpace error', err);
          statusEl.textContent = `Failed to create space. ${err?.message || ''}`;
          statusEl.className = 'status error';
        }
      });
    </script>
  </body>
</html>
