<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Space â€¢ Settings</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1 id="navTitle">Space</h1>
      <a id="navSettings" href="#">Settings</a>
      <a id="navMembers" href="#">Members</a>
      <a id="navModeration" href="#">Moderation</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2 id="spaceNameTitle">Space</h2>
      </div>
      <div class="section">
        <h2>Settings</h2>
        <label style="display:flex; gap:8px; align-items:center; margin:8px 0;">
          <input type="checkbox" id="requireReview" />
          Require Review/Approval
          <span id="requireReviewNote" style="margin-left:8px; color:#666; font-size:12px;"></span>
        </label>
        <div id="reviewBanner" style="border:1px solid #e3e8f3; background:#f0f3fa; color:#222; padding:8px 10px; border-radius:8px; font-size:13px; margin:8px 0;"></div>

        <div class="field">
          <label for="commentsPolicy">Comments Policy</label>
          <select id="commentsPolicy">
            <option value="on">On</option>
            <option value="off">Off</option>
            <option value="inherit">Inherit</option>
          </select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="saveBtn">Save Settings</button>
        </div>
        <div class="status" id="status"></div>
      </div>

      <div class="section">
        <h3>Subscribers</h3>
        <div class="status" id="subStatus"></div>
        <table style="margin-top:12px;">
          <thead>
            <tr><th>User</th><th>Tier</th><th>Status</th><th>Started</th><th>Ended</th></tr>
          </thead>
          <tbody id="subsRows"></tbody>
        </table>
      </div>
    </main>
    <script>
      (function(){
        function parseContext(){
          var p = location.pathname;
          var m = p.match(/^\/(spaces|groups|channels)\/(\d+)\/(?:admin\/settings)/);
          if (!m) return { type:'spaces', id:null };
          return { type: m[1], id: Number(m[2]) };
        }
        var ctx = parseContext();
        var sid = ctx.id;
        function setNav(){
          var base = '/' + ctx.type + '/' + sid;
          var label = ctx.type === 'spaces' ? 'Space' : ctx.type === 'groups' ? 'Group' : 'Channel';
          var title = document.getElementById('navTitle'); if (title) title.textContent = label + ' Admin';
          var s = document.getElementById('navSettings'); if (s) s.href = base + '/admin/settings';
          var m = document.getElementById('navMembers'); if (m) m.href = base + '/admin/members';
          var mod = document.getElementById('navModeration'); if (mod) mod.href = base + '/moderation';
        }
        function setBanner(siteEnforced, spaceReq){
          var el = document.getElementById('reviewBanner'); if (!el) return;
          if (siteEnforced) { el.textContent = 'Effective Review: Required (Site enforced)'; return; }
          if (spaceReq) { el.textContent = 'Effective Review: Required (Space setting)'; return; }
          el.textContent = 'Effective Review: Not required';
        }
        async function loadSettings(){
          const status = document.getElementById('status');
          try{
            const res = await fetch('/api/spaces/' + sid + '/settings', { credentials:'same-origin' });
            if (!res.ok) throw new Error('failed');
            const data = await res.json();
            var title = document.getElementById('spaceNameTitle'); if (title) title.textContent = data && data.name ? data.name : (ctx.type === 'groups' ? 'Group' : ctx.type === 'channels' ? 'Channel' : 'Space');
            const rrEl = document.getElementById('requireReview');
            const noteEl = document.getElementById('requireReviewNote');
            const type = String(data.type||'');
            const settings = data.settings || {};
            const siteEnforced = !!(data.site && data.site.siteEnforced);
            const defReq = type === 'channel' ? true : type === 'group' ? false : false;
            const spaceReq = (settings.publishing && typeof settings.publishing.requireApproval === 'boolean') ? !!settings.publishing.requireApproval : defReq;
            rrEl.checked = siteEnforced ? true : spaceReq;
            rrEl.disabled = siteEnforced;
            noteEl.textContent = siteEnforced ? 'Enforced by Site settings' : '';
            setBanner(siteEnforced, rrEl.checked);
            if (!siteEnforced) {
              rrEl.addEventListener('change',()=>{ setBanner(false, rrEl.checked); });
            }
            var cp = (settings && settings.comments) ? String(settings.comments) : 'on';
            var sel = document.getElementById('commentsPolicy');
            if (sel) sel.value = ['on','off','inherit'].includes(cp) ? cp : 'on';
          }catch(e){ status.textContent='Failed to load settings'; status.className='status error'; }
        }
        function csrf(){ const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/); return m?decodeURIComponent(m[1]):null }
        function headers(){ const h={'Content-Type':'application/json'}; const t=csrf(); if(t) h['x-csrf-token']=t; return h }
        async function save(){
          const status = document.getElementById('status');
          try{
            const rrEl = document.getElementById('requireReview');
            const sel = document.getElementById('commentsPolicy');
            const body = { commentsPolicy: sel ? sel.value : undefined };
            if (!rrEl.disabled) body.requireReview = !!rrEl.checked;
            const res = await fetch('/api/spaces/' + sid + '/settings', { method:'PUT', headers: headers(), credentials:'same-origin', body: JSON.stringify(body) });
            if (!res.ok) throw new Error('failed');
            status.textContent='Saved'; status.className='status ok';
            await loadSettings();
          }catch(e){ status.textContent='Failed to save'; status.className='status error'; }
        }
        async function loadSubs(){
          const tbody = document.getElementById('subsRows');
          const st = document.getElementById('subStatus');
          try{
            const res = await fetch('/api/spaces/' + sid + '/subscribers', { credentials:'same-origin' });
            if (!res.ok) throw new Error('failed');
            const data = await res.json();
            const items = Array.isArray(data.subscribers) ? data.subscribers : [];
            if (!items.length){ tbody.innerHTML='<tr><td colspan="5">No subscribers.</td></tr>'; return; }
            tbody.innerHTML = '';
            items.forEach(function(s){
              var name = s.displayName || s.email || ('User #'+s.userId);
              var tr = document.createElement('tr');
              tr.innerHTML = '<td>'+name+'</td><td>'+(s.tier||'')+'</td><td>'+s.status+'</td><td>'+(s.startedAt||'')+'</td><td>'+(s.endedAt||'')+'</td>';
              tbody.appendChild(tr);
            })
          } catch(e){ st.textContent='Failed to load subscribers'; st.className='status error'; }
        }
        setNav();
        if (sid) { loadSettings(); loadSubs(); }
        var btn = document.getElementById('saveBtn'); if (btn) btn.addEventListener('click', save);
      })();
    </script>
  </body>
  </html>
