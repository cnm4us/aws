<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin • User</title>
    <link rel="stylesheet" href="/admin-nav.css" />
  </head>
  <body>
    <nav class="sidebar">
      <h1>Admin</h1>
      <a href="/admin/settings">Site Settings</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/groups">Groups</a>
      <a href="/admin/channels">Channels</a>
    </nav>
    <main class="main">
      <div class="section">
        <h2 id="title">User</h2>
        <div class="field"><label for="email">Email</label><input id="email" type="email" /></div>
        <div class="field"><label for="displayName">Display Name</label><input id="displayName" type="text" /></div>
        <div class="field"><label for="password">New Password</label><input id="password" type="password" placeholder="Leave blank to keep" /></div>
        <div class="field"><label for="phoneNumber">Phone</label><input id="phoneNumber" type="text" /></div>
        <div class="field"><label for="verificationLevel">Verification Level</label><input id="verificationLevel" type="number" min="0" /></div>
        <div class="field"><label for="kycStatus">KYC Status</label>
          <select id="kycStatus">
            <option value="none">none</option>
            <option value="pending">pending</option>
            <option value="verified">verified</option>
            <option value="rejected">rejected</option>
          </select>
        </div>
        <div class="field"><label for="canCreateGroup">Can Create Group (override)</label>
          <select id="canCreateGroup"><option value="">inherit</option><option value="true">allow</option><option value="false">deny</option></select>
        </div>
        <div class="field"><label for="canCreateChannel">Can Create Channel (override)</label>
          <select id="canCreateChannel"><option value="">inherit</option><option value="true">allow</option><option value="false">deny</option></select>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="btn" id="saveBtn">Save</button>
          <button class="btn danger" id="deleteBtn">Soft Delete</button>
          <a class="btn" href="/admin/users">Back</a>
        </div>
        <div class="status" id="status"></div>
      </div>

      <div class="section">
        <h3>Memberships</h3>
        <div id="spaces"></div>
      </div>
    </main>
    <script>
      const params = new URLSearchParams(location.search);
      const idMatch = location.pathname.match(/\/admin\/users\/(\d+)/);
      const userId = idMatch? Number(idMatch[1]): null;
      const csrf=()=>{const m=document.cookie.match(/(?:^|;\s*)csrf=([^;]+)/);return m?decodeURIComponent(m[1]):null};
      const headers=()=>{const h={'Content-Type':'application/json'};const t=csrf();if(t)h['x-csrf-token']=t;return h};

      async function load(){
        if(!userId) { document.getElementById('status').textContent='Bad user id'; return }
        try{
          const res = await fetch(`/api/admin/users/${userId}`, { credentials:'same-origin' });
          const u = await res.json();
          document.getElementById('title').textContent = `User #${u.id}`;
          document.getElementById('email').value = u.email||'';
          document.getElementById('displayName').value = u.displayName||'';
          document.getElementById('phoneNumber').value = u.phoneNumber||'';
          document.getElementById('verificationLevel').value = u.verificationLevel||0;
          document.getElementById('kycStatus').value = u.kycStatus||'none';
          document.getElementById('canCreateGroup').value = u.canCreateGroup===true ? 'true' : u.canCreateGroup===false ? 'false' : '';
          document.getElementById('canCreateChannel').value = u.canCreateChannel===true ? 'true' : u.canCreateChannel===false ? 'false' : '';

          const sres = await fetch(`/api/admin/users/${userId}/spaces`, { credentials:'same-origin' });
          const sj = await sres.json();
          const container = document.getElementById('spaces');
          container.innerHTML='';
          (sj.spaces||[]).forEach(sp=>{
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            const path = sp.type==='group' ? `/admin/groups/${sp.id}/user/${userId}` : `/admin/channels/${sp.id}/user/${userId}`;
            div.innerHTML = `<strong>${sp.type.toUpperCase()}</strong> • <a href="${path}">${sp.name}</a> <span style="color:#666; margin-left:8px;">Roles: ${(sp.roles||[]).join(', ')}</span>`;
            container.appendChild(div);
          })
        }catch(e){ const s=document.getElementById('status'); s.textContent='Failed to load user'; s.className='status error' }
      }

      async function save(){
        const body={
          email: document.getElementById('email').value.trim(),
          displayName: document.getElementById('displayName').value.trim(),
          password: document.getElementById('password').value || undefined,
          phoneNumber: document.getElementById('phoneNumber').value.trim() || null,
          verificationLevel: Number(document.getElementById('verificationLevel').value||0),
          kycStatus: document.getElementById('kycStatus').value,
          canCreateGroup: (v=> v===''? null : v==='true')(document.getElementById('canCreateGroup').value),
          canCreateChannel: (v=> v===''? null : v==='true')(document.getElementById('canCreateChannel').value),
        };
        try{
          const res = await fetch(`/api/admin/users/${userId}`, { method:'PUT', headers: headers(), credentials:'same-origin', body: JSON.stringify(body) });
          if(!res.ok){ const err=await res.json().catch(()=>({})); throw new Error(err?.detail||err?.error||'Failed') }
          const s=document.getElementById('status'); s.textContent='Saved'; s.className='status ok'
          if(body.password){ document.getElementById('password').value=''; }
        }catch(e){ const s=document.getElementById('status'); s.textContent=e?.message||'Failed to save'; s.className='status error' }
      }

      async function softDelete(){
        if(!confirm('Soft delete this user?')) return;
        try{ await fetch(`/api/admin/users/${userId}`, { method:'DELETE', headers: headers(), credentials:'same-origin' });
          const s=document.getElementById('status'); s.textContent='User marked deleted'; s.className='status ok' }
        catch(e){ const s=document.getElementById('status'); s.textContent='Failed to delete'; s.className='status error' }
      }
      document.getElementById('saveBtn').addEventListener('click', save);
      document.getElementById('deleteBtn').addEventListener('click', softDelete);
      load();
    </script>
  </body>
  </html>
